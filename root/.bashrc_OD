#------------------------------------------------------------------------------
#          Harvard University Atmospheric Chemistry Modeling Group            !
#------------------------------------------------------------------------------
#BOP
#
# !MODULE: .bashrc_OD
#
# !DESCRIPTION: File containing environment settings for the bash shell on
#  the Odyssey cluster. Rename this file .bashrc when copying to your
#  home directory on Odyssey.
#\\
#\\
# !CALLING SEQUENCE:
#  source ~/.bashrc
#
# !REMARKS:
#  We have included settings that are common to all GEOS-Chem users on the 
#  Odyssey cluster (rc.fas.harvard.edu), including frequently used libraries 
#  and paths and aliases for common Unix commands. You can define additional 
#  aliases that are only applicable to your own environment in the file 
#  .my_personal_settings.
#
#  You can copy this file to ~/.bashrc in your root directory and edit
#  as you wish.
#
#  To load a new set of modules for a different compiler version, you can
#  issue the folloiwng commands,
#
#    export LOAD_COMPILER=ifort15; . ~/.bashrc; unset LOAD_COMPILER
#    export LOAD_COMPILER=ifort13; . ~/.bashrc; unset LOAD_COMPILER
#    export LOAD_COMPILER=ifort11; . ~/.bashrc; unset LOAD_COMPILER
#    export LOAD_COMPILER=pgi;     . ~/.bashrc; unset LOAD_COMPILER
#
#  or use the following aliases defined in this file:
#
#    load_15      # load ifort 15
#    load_13      # load ifort 13
#    load_11      # load ifort 11 (default compiler when you log in)
#    load_pg      # load PGI
#    load_gf      # load GNU Fortran
#
#  ALSO NOTE: If you want to use the totalview debugger, you have to type:
#
#    module load totalview
# 
#  in your Unix session.
#
# !REVISION HISTORY:
#  Change directory to ~/env and type 'gitk' at the prompt to browse
#  revision history.
#EOP
#------------------------------------------------------------------------------
#BOC

#==============================================================================
# %%%%% General system startup settings %%%%%
#==============================================================================

# %%%%% Source systemwide global definitions from /etc/bashrc %%%%%
if [[ -f /etc/bashrc ]] ; then
 . /etc/bashrc
fi

# %%%%% Set Unix prompt to be "[USER@HOST CWD]$" %%%%%
# Use green for Odyssey to contrast with red on AS
# NOTE: You may override this setting by adding your own definition of 
# PS1 in .my_personal_settings.
PS1="\[\e[1;32m\][\u@\h \W]$\[\e[0m\] "

# %%%%% Startup settings %%%%%
umask 022                          # Make files readable by everyone by default
set autolist                       # Turn on list completion
set correct                        #
set color                          # 
set colorcat                       # 
set filesc                         #
set emacs                          # Use an emacs-style editing interface
set history                        # Turn on history of commands
set ignoreeof                      # Prevent EOF from terminating the shell
ulimit -t unlimited                # Max out cputime
ulimit -f unlimited                # Max out filesize
ulimit -d unlimited                # Max out datasize
ulimit -s unlimited                # Max out stacksize
ulimit -c unlimited                # Max out coredumpsize
unset GC_F_BIN
unset GC_F_INCLUDE
unset GC_F_LIB

#==============================================================================
# %%%%% Settings for loading software modules %%%%%
#==============================================================================

# Pick the compiler version to load, based on the LOAD_COMPILER env var
# If LOAD_COMPILER is not set, then load the Jacob-group libraries 
if [[ -n "${LOAD_COMPILER+1}" ]]; then
  loadThisCompiler=$LOAD_COMPILER
else
  loadThisCompiler="ifort11" 
fi

# Echo info if it's an interactive session
if [[ $- = *i* ]] ; then
  echo "Loading modules for compiler $loadThisCompiler, please wait ..."
fi

# Activate Lmod and load commonly-used modules 
export LMOD_COLORIZE=yes                                   # Colorize
source new-modules.sh                                      # Turn on Lmod
export MODULEPATH="/n/seasasfs01/modulefiles:$MODULEPATH"  # Jacob grp path
module purge                                               # Initialize
module load git                                            # Load Git
module load perl                                           # Load Perl
module load IDL                                            # Load IDL
module load ncl                                            # Load NCL v6.1.2

if [[ $loadThisCompiler == "ifort15" ]]; then

  #-----------------------------------------------------
  # %%%%% FOR GEOS-CHEM with IFORT 15 %%%%%
  #-----------------------------------------------------
  module load intel/15.0.0-fasrc01 openmpi/1.8.3-fasrc02   # ifort v15 & MPI
  module load netcdf/4.1.3-fasrc04                         # Load netCDF
  module load tau/2.24.1-fasrc01                           # Load TAU
  #module load ncview/2.1.5-fasrc01                         # Load ncview
  #module load nco/4.3.6-fasrc01                            # Load nco

  # Options for TAU profiler
  export TAU_OPTIONS="-optRevert -optVerbose -optPreProcess -optContinueBeforeOMP"

elif [[ $loadThisCompiler == "ifort13" ]]; then

  #-----------------------------------------------------
  # %%%%% FOR GEOS-CHEM with IFORT 13 %%%%%
  #-----------------------------------------------------
  module load intel/13.0.079-fasrc01 openmpi/1.8.1-fasrc05 netcdf/4.1.3-fasrc06 

elif [[ $loadThisCompiler == "pgi" ]]; then

  #-----------------------------------------------------
  # %%%%% FOR GEOS-CHEM with PGI COMPILER %%%%%
  #
  # NOTE: A license file is automatically set when 
  # loading IDL upon startup but must be unset prior to
  # compiling with PGI. To subsequently use IDL, type:
  #    export LM_LICENSE_FILE=27001@rlic1
  # after you are done compiling.
  #------------------------------------------------------
  unset LM_LICENSE_FILE 
  module load pgi/14.10-fasrc01 openmpi/1.10.0-fasrc02 netcdf/4.1.3-fasrc05

elif [[ $loadThisCompiler == "gfortran" ]]; then

  #-----------------------------------------------------
  # %%%%% GEOS-CHEM WITH GNU FORTRAN COMPILER %%%%% 
  #-----------------------------------------------------

  # These commands load GNU Fortran 4.8.2
  module load gcc/4.8.2-fasrc01      openmpi/1.10.1-fasrc01
  module load netcdf/4.3.3.1-fasrc02 netcdf-fortran/4.4.2-fasrc01

else

  #-----------------------------------------------------
  # %%%%% GEOS-CHEM WITH JACOB-GROUP LIBRARIES %%%%% 
  #
  # This is the default setting.  This will load the
  # same netCDF, IFORT compiler (v11), and Totalview 
  # versions that are used on the AS cluster. 
  #-----------------------------------------------------
  module load intel/11.1 GEOS-Chem-Libraries

  # Manually point to GEOS-Chem-Libraries build
  export NETCDF_HOME=/n/seasasfs01/opt/odyssey/GEOS-Chem-Libraries/ifort/nc4
  export NETCDF_INCLUDE=${NETCDF_HOME}/include
  export NETCDF_LIB=${NETCDF_HOME}/lib
  export NETCDF_BIN=${NETCDF_HOME}/bin
  export PATH="$NETCDF_BIN:$PATH"

  # GEOS-Chem-Libraries does not set the compiler variables
  # so we must do that manually here (bmy, 1/27/16)
  export FC=ifort
  export CC=icc
  export CXX=icpc

fi

# Display loaded modules if it's an interactive session
if [[ $- = *i* ]] ; then
  module list
fi

# Undefine temporary variables
unset loadThisCompiler

#==============================================================================
# %%%%% Settings for data paths %%%%%
#==============================================================================

# %%%%% Settings for GIGCsa %%%%%
export ARCH=`uname -s`

# %%%%% Settings for netCDF, HDF, etc. libraries %%%%%

# If the netCDF home directory hasn't been set, do it manually here
if [[ "x$NETCDF_HOME" == x ]]; then
 export NETCDF_HOME=`nc-config --prefix`
fi

# If the $NETCDF_LIB variable is blank, set it to "$NETCDF_HOME/lib"
if [[ "x$NETCDF_LIB" == x ]]; then 
 export GC_LIB="$NETCDF_HOME/lib"
else
 export GC_LIB="$NETCDF_LIB"
fi

# If the $NETCDF_INCLUDE variable is blank, set it to "$NETCDF_HOME/include"
if [[ "x$NETCDF_INCLUDE" == x ]]; then
 export GC_INCLUDE="$NETCDF_HOME/include"
else
 export GC_INCLUDE="$NETCDF_INCLUDE"         
fi

# netCDF bin path
export GC_BIN="$NETCDF_HOME/bin"

# If the netCDF-Fortran library is loaded separately
# then also define the GC_F_* environment variables
if [[ "x$NETCDF_FORTRAN_HOME" != x ]]; then
 export GC_F_BIN="$NETCDF_FORTRAN_HOME/bin"
 export GC_F_INCLUDE="$NETCDF_FORTRAN_INCLUDE"
 export GC_F_LIB="$NETCDF_FORTRAN_LIB"
fi

# Set flags for backwards compatibility w/ other code packages
export BIN_NETCDF=$GC_BIN
export INC_NETCDF=$GC_INCLUDE
export LIB_NETCDF=$GC_LIB
export BIN_HDF5=$GC_BIN
export INC_HDF5=$GC_INCLUDE
export LIB_HDF5=$GC_LIB

# %%%%% Settings for met field & emissions directories %%%%%
dataDir="/n/seasasfs01/gcgrid/data"
dataDirReadOnly="/n/seasasfs01/gcgrid/data"
export DATA_ROOT="$dataDirReadOnly/ExtData"
export DATA_ROOT_RW="$dataDir/ExtData"
export HEMCO_DATA_ROOT="$dataDirReadOnly/ExtData/HEMCO"
export HEMCO_DATA_ROOT_RW="$dataDir/ExtData/HEMCO"
export EXTDATA="$dataDirReadOnly/ExtData"
export EXTDATA_RW="$dataDir/ExtData"

#==============================================================================
# %%%%% Settings for programming languages and applications %%%%%
#==============================================================================

# %%%%% Settings for compilers %%%%%
export COMPILER=$FC
export F90=$FC
export F77=$FC
export OMPI_FC=$FC
export OMPI_CC=$CC
export OMPI_CXX=$CXX

# %%%%% Settings for OpenMP parallelization %%%%%

# Max out the stack memory for OpenMP
# OMP_STACKSIZE works with all compilers; KMP_STACKSIZE works only w/ Intel
export OMP_STACKSIZE=500m

# If we are in a SLURM environment (i.e. interactive run or batch job),
# then set OMP_NUM_THREADS to the value of SLURM_CPUS_PER_TASK.  Otherwise,
# set OMP_NUM_THREADs to a default value of 1. (bmy, 9/2/15)
if [[ -n "${SLURM_CPUS_PER_TASK+1}" ]]; then
  export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK
else
  export OMP_NUM_THREADS=1
fi

# %%%%% Settings for IDL %%%%%
export IDL_STARTUP="$HOME/IDL/idl_startup.pro"

# %%%%% Settings for Python %%%%%
export PYTHONSTTARTUP="$HOME/python/python_startup.py"

# %%%%% Settings for Ghostview %%%%%
export GS_DEVICE="x11"

# %%%%% Settings for Git %%%%%
source /etc/bash_completion.d/git           # enable tab-completion for git

#==============================================================================
# %%%%% Settings for colorization  %%%%%
#==============================================================================

export GREP_COLOR=32
export LS_COLORS='no=00:fi=00:di=01;33:ln=01;36:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:su=37;41:sg=30;43:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;37:*.tgz=01;37:*.arj=01;37:*.taz=01;37:*.lzh=01;37:*.zip=01;37:*.z=01;37:*.Z=01;37:*.gz=01;37:*.bz2=01;37:*.deb=01;37:*.rpm=01;37:*.jar=01;37:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.avi=01;35:*.fli=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.flac=01;35:*.mp3=01;35:*.mpc=01;35:*.ogg=01;35:*.wav=01;35:'

#==============================================================================
# %%%%% Environment settings %%%%%%
#==============================================================================
export TERM=xterm                        # Default terminal
export EDITOR=emacs                      # Default editor (emacs or vim)
export VISUAL=emacs                      # Default editor (emacs or vim)
export GIT_EDITOR=emacs                  # Default Git editor (emacs or vim)
export MAIL=/usr/spool/mail/$USER        # Default mail program
mail=$MAIL

#==============================================================================
# %%%%% Shortcut aliases (add your own to .my_personal_settings) %%%%%
#==============================================================================

# %%%%% Alias to pull env directory updates %%%%%
alias  getenv="cd ~/env; git pull origin master"

# %%%%% Aliases to load different compiler versions %%%%%
alias  load_15="export LOAD_COMPILER=ifort15; sb; unset LOAD_COMPILER"
alias  load_13="export LOAD_COMPILER=ifort13; sb; unset LOAD_COMPILER"
alias  load_11="export LOAD_COMPILER=ifort11; sb; unset LOAD_COMPILER"
alias  load_pg="export LOAD_COMPILER=pgi; sb; unset LOAD_COMPILER"
alias  load_gf="export LOAD_COMPILER=gfortran; sb; unset LOAD_COMPILER"

# %%%%% Aliases for general Unix commands %%%%
alias  disk="du -h -s -c"
alias  g="grep -in --color=auto"
alias  gf="gifview"
alias  gt="grep -in --text"
alias  gf="gifview -a"
alias  gvs="gv --orientation=seascape"
alias  m="less"
alias  me="xterm &"
alias  pan="$HOME/bin/panoply.sh &"
alias  proc="ps -ef | grep $USER | sort"
alias  pu="rm *~"
alias  sb=". ~/.bash_profile"
alias  ssh="ssh -X -A"
alias  gsh="ssh -xT"
alias  tf="tail --follow"
alias  zap="kill -9"

# %%%%% Aliases for directory listing %%%%%
alias  ls="ls -CF --time-style=long-iso --color=auto"
alias  l1="ls -1"
alias  ll="ls -l"
alias  llt="ls -lt"
alias  lltm="ls -lt | less"
alias  la="ls -a"
alias  lla="ls -la"
alias  llh="ls -lh"

# %%%%% Aliases for Git and GitHub %%%%%
alias  gui="git gui &"
alias  gk="gitk &"
alias  gka="gitk --all &"
alias  gl="git log"
alias  glo="git log --oneline"
alias  glp="git log --pretty=format:'%h : %s' --topo-order --graph"

# %%%%% Aliases for IDL and GAMAP %%%%%
alias  I="cd $HOME/IDL"
alias  IG="cd $HOME/IDL/gamap2"
alias  IS="cd $HOME/IDL/tests"

# %%%%% Aliases for MET data %%%%%
alias  XC="cd $dataDir/GEOS_0.5x0.666_CH"
alias  XC5="cd $dataDir/GEOS_0.5x0.666_CH.d/GEOS_5"
alias  XS="cd $dataDir/GEOS_0.25x0.3125_NA"
alias  XNFP="cd $dataDir/GEOS_0.25x0.3125_NA.d/GEOS_FP"
alias  XN="cd $dataDir/GEOS_0.5x0.666_NA"
alias  XN5="cd $dataDir/GEOS_0.5x0.666_NA.d/GEOS_5"
alias  X1="cd $dataDir/GEOS_1x1"
alias  XNN="cd $dataDir/GEOS_NATIVE"
alias  X2="cd $dataDir/GEOS_2x2.5"
alias  X24="cd $dataDir/GEOS_2x2.5.d/GEOS_4_v4"
alias  X25="cd $dataDir/GEOS_2x2.5.d/GEOS_5"
alias  X2FP="cd $dataDir/GEOS_2x2.5.d/GEOS_FP"
alias  X2M="cd $dataDir/GEOS_2x2.5.d/MERRA"
alias  X2M2="cd $dataDir/GEOS_2x2.5.d/MERRA2"
alias  X4="cd $dataDir/GEOS_4x5"
alias  X44="cd $dataDir/GEOS_4x5/GEOS_4_v4"
alias  X45="cd $dataDir/GEOS_4x5/GEOS_5"
alias  X4FP="cd $dataDir/GEOS_4x5/GEOS_FP"
alias  X4M="cd $dataDir/GEOS_4x5/MERRA"
alias  X4M2="cd $dataDir/GEOS_4x5/MERRA2"
unset dataDir
unset dataDirReadOnly

#==============================================================================
# %%%%% Source a file with your own personal aliases and settings %%%%%
#==============================================================================

if [[ -f $HOME/.my_personal_settings ]] ; then
 . $HOME/.my_personal_settings
fi

#==============================================================================
# %%%%% Alter standard path settings for Odyssey %%%%%
#==============================================================================

# %%%%% Add GC_LIB to the LD_LIBRARY_PATH %%%%%
export LD_LIBRARY_PATH="$GC_LIB:$LD_LIBRARY_PATH"

#EOC
